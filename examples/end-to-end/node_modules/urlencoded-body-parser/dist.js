const getRawBody = require('raw-body')
const typer = require('media-typer')
const { parse } = require('qs')

module.exports = function parseFormData (req, {limit = '1mb'} = {}) {return __async(function*(){
  const type = req.headers['content-type']
  const encoding = (type) ? typer.parse(type).parameters.charset : 'UTF-8'

  req.rawBody = req.rawBody || getRawBody(req, {limit, encoding})
  const str = yield req.rawBody
  const data = parse(str.toString())

  return data
}())}

function __async(g){return new Promise(function(s,j){function c(a,x){try{var r=g[x?"throw":"next"](a)}catch(e){j(e);return}r.done?s(r.value):Promise.resolve(r.value).then(c,d)}function d(e){c(e,1)}c()})}
